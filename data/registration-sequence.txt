@startuml
title OCPI Registration process

participant CPO
participant eMSP

== Offline ==

CPO -> CPO: Generate token: TOKEN_A
CPO -> eMSP: send credentials \n("/ocpi/cpo/versions", TOKEN_A, ...)

...

== OCPI ==

CPO <- eMSP: GET /ocpi/cpo/versions
activate eMSP
activate CPO
note right
    The eMSP uses TOKEN_A as authentication
    to fetch information from the CPO.
end note
CPO --> eMSP: Available versions
deactivate CPO

eMSP -> eMSP: Pick latest compatible version (e.g. 2.0)\nand store it.
CPO <- eMSP: GET /ocpi/cpo/2.0/
activate CPO
CPO --> eMSP: Available endpoints for v2.0
deactivate CPO

eMSP -> eMSP: Generate token: TOKEN_B
CPO <- eMSP: POST /ocpi/cpo/2.0/credentials \n("/ocpi/emsp/versions", TOKEN_B, ...)

activate CPO
CPO -> CPO: Store used version: 2.0
note right
    The CPO knows it's version 2.0 because
    of the endpoint. The version is stored
    for PUSH notifications and the like.
end note
CPO -> CPO: Store TOKEN_B
CPO -> CPO: Generate TOKEN_C
CPO --> eMSP: Credentials with TOKEN_C for eMSP
deactivate CPO

deactivate eMSP

note right
    By returning new credentials for the eMSP,
    the initial setup token (TOKEN_A)
    has now become invalid.
end note

@enduml
